<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPS Buy Phase Working</title>
<style>
  body { margin:0; overflow:hidden; background:#222; font-family:sans-serif; }
  #ui { position:absolute; top:10px; left:10px; color:white; z-index:2; }
  #buyScreen {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95); color:white; display:flex;
    justify-content:center; align-items:center; flex-direction:column; font-size:24px; z-index:5;
  }
  .weaponBtn { background:#333; border:2px solid white; padding:10px 20px; margin:10px; cursor:pointer; }
</style>
</head>
<body>
<div id="ui">Health: 100 | Weapon: None</div>

<div id="buyScreen">
  <div>Buy Your Weapon! Time left: <span id="timer">20</span>s</div>
  <div id="weaponButtons"></div>
  <div id="buyMessage" style="margin-top:20px; display:none;">Click anywhere to start FPS!</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>

<script>
  // === Buy Phase Variables ===
  let selectedWeapon = "None";
  const weapons = ["Pistol","SMG","Rifle","Shotgun","Sniper","Butterfly Knife"];
  const weaponButtonsDiv = document.getElementById("weaponButtons");
  const timerSpan = document.getElementById('timer');
  const buyScreen = document.getElementById('buyScreen');
  const buyMessage = document.getElementById('buyMessage');

  // Create weapon buttons
  weapons.forEach(w=>{
    const btn = document.createElement("div");
    btn.className = "weaponBtn";
    btn.innerText = w;
    btn.onclick = ()=>{
      selectedWeapon = w;
      document.getElementById("ui").innerText = `Health: 100 | Weapon: ${selectedWeapon}`;
    };
    weaponButtonsDiv.appendChild(btn);
  });

  // === Three.js Scene Setup ===
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,2,15);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Lights
  const ambient = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambient);
  const directional = new THREE.DirectionalLight(0xffffff,0.6);
  directional.position.set(10,20,10);
  scene.add(directional);

  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(50,50),
    new THREE.MeshLambertMaterial({color:0x228833})
  );
  ground.rotation.x = -Math.PI/2;
  scene.add(ground);

  // Obstacles
  const obstacles = [];
  const obstaclePositions = [[-5,1,0],[5,1,0],[0,1,-5],[0,1,5],[-3,1,-3],[3,1,3],[-3,1,3],[3,1,-3]];
  obstaclePositions.forEach(pos=>{
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(2,2,2),
      new THREE.MeshLambertMaterial({color:0x555555})
    );
    cube.position.set(pos[0], pos[1], pos[2]);
    scene.add(cube);
    obstacles.push(cube);
  });

  // AI Enemies
  const enemies = [];
  for(let i=0;i<3;i++){
    const enemy = new THREE.Mesh(
      new THREE.BoxGeometry(1.5,1.5,1.5),
      new THREE.MeshLambertMaterial({color:0xff5555})
    );
    enemy.position.set(Math.random()*20-10,0.75,Math.random()*20-10);
    scene.add(enemy);
    enemy.health = 100;
    enemies.push(enemy);
  }

  // Buy Boxes
  const buyBoxes = [];
  const buyPositions = [[-8,1,-8],[8,1,-8],[0,1,8]];
  buyPositions.forEach((pos,i)=>{
    const box = new THREE.Mesh(
      new THREE.BoxGeometry(2,2,2),
      new THREE.MeshLambertMaterial({color:0x0000ff})
    );
    box.position.set(pos[0], pos[1], pos[2]);
    scene.add(box);
    buyBoxes.push(box);
  });

  // PointerLockControls
  const controls = new THREE.PointerLockControls(camera, renderer.domElement);

  // Movement
  const keys = {};
  document.addEventListener('keydown', e=>keys[e.code]=true);
  document.addEventListener('keyup', e=>keys[e.code]=false);

  // Bullets
  const bullets = [];
  document.addEventListener('mousedown', ()=>{
    const bullet = new THREE.Mesh(
      new THREE.SphereGeometry(0.1,8,8),
      new THREE.MeshBasicMaterial({color:0xffff00})
    );
    bullet.position.copy(camera.position);
    bullet.direction = new THREE.Vector3();
    camera.getWorldDirection(bullet.direction);
    bullets.push(bullet);
    scene.add(bullet);
  });

  // === Buy Timer using requestAnimationFrame (robust) ===
  let buyTime = 20;
  let lastTime = Date.now();
  function updateTimer(){
    const now = Date.now();
    if(now - lastTime >= 1000){
      buyTime--;
      timerSpan.innerText = buyTime;
      lastTime = now;
    }
    if(buyTime > 0){
      requestAnimationFrame(updateTimer);
    } else {
      buyMessage.style.display = "block";
      document.addEventListener('click', ()=>{
        buyScreen.style.display='none';
        controls.lock();
      }, {once:true});
    }
  }
  requestAnimationFrame(updateTimer);

  // Player movement & bullets
  function movePlayer(){
    const speed = 0.2;
    const velocity = new THREE.Vector3();
    if(keys['KeyW']) velocity.z -= speed;
    if(keys['KeyS']) velocity.z += speed;
    if(keys['KeyA']) velocity.x -= speed;
    if(keys['KeyD']) velocity.x += speed;
    controls.moveRight(velocity.x);
    controls.moveForward(velocity.z);

    // Check buy boxes
    buyBoxes.forEach((box,i)=>{
      const dx = camera.position.x - box.position.x;
      const dz = camera.position.z - box.position.z;
      const dist = Math.sqrt(dx*dx + dz*dz);
      if(dist < 2){
        document.getElementById('ui').innerText = `Health: 100 | Weapon: ${weapons[i]}`;
      }
    });

    // Bullet collision with enemies
    bullets.forEach((b,i)=>{
      b.position.add(b.direction.clone().multiplyScalar(0.5));
      enemies.forEach((e)=>{
        const dx = b.position.x - e.position.x;
        const dz = b.position.z - e.position.z;
        const dist = Math.sqrt(dx*dx + dz*dz);
        if(dist < 1 && e.health>0){
          e.health -= 50;
          scene.remove(b);
          bullets.splice(i,1);
          if(e.health <=0) scene.remove(e);
        }
      });
      if(b.position.length()>100){
        scene.remove(b);
        bullets.splice(i,1);
      }
    });
  }

  function animate(){
    requestAnimationFrame(animate);
    movePlayer();
    renderer.render(scene,camera);
  }
  animate();

  // Window resize
  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
